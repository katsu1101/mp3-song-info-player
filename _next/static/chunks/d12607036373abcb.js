(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,38142,e=>{"use strict";var t=e.i(81995),a=e.i(93432),r=e.i(6568),s=e.i(1495),i=e.i(30222),n=e.i(19102);let o=(0,a.default)("music-metadata:id3v2:frame-parser"),d="latin1",l={encoding:d,bom:!1};function g(e){return"RX"===e?"Remix":"CR"===e?"Cover":e.match(/^\d*$/)?i.Genres[Number.parseInt(e,10)]:void 0}class c{constructor(e,t){this.major=e,this.warningCollector=t}readData(e,a,i){let n;if(0===e.length)return void this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${a}`);let{encoding:m,bom:u}=s.TextEncodingToken.get(e,0),p=e.length,T=0,f=[],y=c.getNullTerminatorLength(m);switch(o(`Parsing tag type=${a}, encoding=${m}, bom=${u}`),"TXXX"!==a&&"T"===a[0]?"T*":a){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let t;try{t=c.trimNullPadding(r.decodeString(e.subarray(1),m))}catch(e){if(e instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${a} header has invalid string value: ${e.message}`);break}throw e}switch(a){case"TMCL":case"TIPL":case"IPLS":f=c.functionList(this.splitValue(a,t));break;case"TRK":case"TRCK":case"TPOS":f=t;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":f=this.splitValue(a,t);break;case"TCO":case"TCON":f=this.splitValue(a,t).map(e=>(function(e){let t,a=[],r="";for(let s of e)if("string"==typeof t)if("("===s&&""===t)r+="(",t=void 0;else if(")"===s){""!==r&&(a.push(r),r="");let e=g(t);e&&a.push(e),t=void 0}else t+=s;else"("===s?t="":r+=s;return r&&(0===a.length&&r.match(/^\d*$/)&&(r=g(r)),r&&a.push(r)),a})(e)).reduce((e,t)=>e.concat(t),[]);break;case"PCS":case"PCST":f=Array.isArray(f=this.major>=4?this.splitValue(a,t):[t])&&""===f[0]?1:0;break;default:f=this.major>=4?this.splitValue(a,t):[t]}break}case"TXXX":{let t=c.readIdentifierAndData(e.subarray(1),m);f={description:t.id,text:this.splitValue(a,r.decodeString(t.data,m).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(i){let t={};switch(e=e.subarray(1),this.major){case 2:t.format=r.decodeString(e.subarray(0,3),"latin1"),e=e.subarray(3);break;case 3:case 4:n=r.findZero(e,d),t.format=r.decodeString(e.subarray(0,n),d),e=e.subarray(n+1);break;default:throw function(e){throw new h(`Unexpected majorVer: ${e}`)}(this.major)}t.format=c.fixPictureMimeType(t.format),t.type=s.AttachedPictureType[e[0]],e=e.subarray(1),n=r.findZero(e,m),t.description=r.decodeString(e.subarray(0,n),m),t.data=e=e.subarray(n+y),f=t}break;case"CNT":case"PCNT":f=(0,r.decodeUintBE)(e);break;case"SYLT":{let a=s.SyncTextHeader.get(e,0);e=e.subarray(s.SyncTextHeader.len);let r={descriptor:"",language:a.language,contentType:a.contentType,timeStampFormat:a.timeStampFormat,syncText:[]},i=!1;for(;e.length>0;){let s=c.readNullTerminatedString(e,a.encoding);if(e=e.subarray(s.len),i){let a=t.UINT32_BE.get(e,0);e=e.subarray(t.UINT32_BE.len),r.syncText.push({text:s.text,timestamp:a})}else r.descriptor=s.text,i=!0}f=r;break}case"ULT":case"USLT":case"COM":case"COMM":{let t=s.TextHeader.get(e,T);T+=s.TextHeader.len;let a=c.readNullTerminatedString(e.subarray(T),t.encoding);T+=a.len;let r=c.readNullTerminatedString(e.subarray(T),t.encoding);f={language:t.language,descriptor:a.text,text:r.text};break}case"UFID":{let t=c.readIdentifierAndData(e,d);f={owner_identifier:t.id,identifier:t.data};break}case"PRIV":{let t=c.readIdentifierAndData(e,d);f={owner_identifier:t.id,data:t.data};break}case"POPM":{e=e.subarray(T);let s=c.readNullTerminatedString(e,l),i=s.text;if(0===(e=e.subarray(s.len)).length){this.warningCollector.addWarning(`id3v2.${this.major} type=${a} POPM frame missing rating byte`),f={email:i,rating:0,counter:void 0};break}let n=t.UINT8.get(e,0),o=e.subarray(t.UINT8.len);f={email:i,rating:n,counter:o.length>0?(0,r.decodeUintBE)(o):void 0};break}case"GEOB":{let{encoding:t,bom:a}=s.TextEncodingToken.get(e,0);e=e.subarray(1);let r=c.readNullTerminatedString(e,l),i=r.text;e=e.subarray(r.len);let n=c.readNullTerminatedString(e,{encoding:t,bom:a}),o=n.text;e=e.subarray(n.len);let d=c.readNullTerminatedString(e,{encoding:t,bom:a});f={type:i,filename:o,description:d.text,data:e=e.subarray(d.len)};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":f=c.readNullTerminatedString(e,l).text;break;case"WXXX":{let{encoding:t,bom:a}=s.TextEncodingToken.get(e,0);e=e.subarray(1);let i=c.readNullTerminatedString(e,{encoding:t,bom:a}),n=i.text;e=e.subarray(i.len),f={description:n,url:c.trimNullPadding(r.decodeString(e,d))};break}case"WFD":case"WFED":{let{encoding:t,bom:a}=s.TextEncodingToken.get(e,0);e=e.subarray(1),f=c.readNullTerminatedString(e,{encoding:t,bom:a}).text;break}case"MCDI":f=e.subarray(0,p);break;default:o(`Warning: unsupported id3v2-tag-type: ${a}`)}return f}static readNullTerminatedString(e,t){let a=2*!!t.bom,s=e.length,i=e.subarray(a),n=r.findZero(i,t.encoding);if(n>=i.length)return{text:r.decodeString(i,t.encoding),len:s};let o=i.subarray(0,n);return{text:r.decodeString(o,t.encoding),len:a+n+c.getNullTerminatorLength(t.encoding)}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase()){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){let t={};for(let a=0;a+1<e.length;a+=2){let r=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(r):r}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g)).length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g):a=t.split(/\x00/g),c.trimArray(a)}static trimArray(e){return e.map(e=>c.trimNullPadding(e).trim())}static trimNullPadding(e){let t=e.length;for(;t>0&&0===e.charCodeAt(t-1);)t--;return t===e.length?e:e.slice(0,t)}static readIdentifierAndData(e,t){let a=c.readNullTerminatedString(e,{encoding:t,bom:!1});return{id:a.text,data:e.subarray(a.len)}}static getNullTerminatorLength(e){return e.startsWith("utf-16")?2:1}}class h extends(0,n.makeUnexpectedFileContentError)("id3v2"){}var m=e.i(62950);function u(e){throw new h(`Unexpected majorVer: ${e}`)}class p{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=255===e[t]&&0===e[t+1]?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.subarray(0,a)}static readFrameData(e,t,a,r,s){let i=new c(a,s);switch(a){case 2:return i.readData(e,t.id,r);case 3:case 4:return t.flags?.format.unsynchronisation&&(e=p.removeUnsyncBytes(e)),t.flags?.format.data_length_indicator&&(e=e.subarray(4,e.length)),i.readData(e,t.id,r);default:throw function(e){throw new h(`Unexpected majorVer: ${e}`)}(a)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}async parse(e,t,a){this.tokenizer=t,this.metadata=e,this.options=a;let r=await this.tokenizer.readToken(s.ID3v2Header);if("ID3"!==r.fileIdentifier)throw new h("expected ID3-header file-identifier 'ID3' was not found");return this.id3Header=r,this.headerType=`ID3v2.${r.version.major}`,r.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(r.size)}async parseExtendedHeader(){let e=await this.tokenizer.readToken(s.ExtendedHeader),t=e.size-s.ExtendedHeader.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(e){let a=await this.tokenizer.readToken(new t.Uint8ArrayType(e));for(let e of this.parseMetadata(a))"TXXX"===e.id?e.value&&await this.handleTag(e,e.value.text,()=>e.value.description):await (Array.isArray(e.value)?Promise.all(e.value.map(t=>this.addTag(e.id,t))):this.addTag(e.id,e.value))}async handleTag(e,t,a,r=e=>e){await Promise.all(t.map(t=>this.addTag(p.makeDescriptionTagName(e.id,a(t)),r(t))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(e){let a=0,i=[];for(;a!==e.length;){let n=function(e){switch(e){case 2:return 6;case 3:case 4:return 10;default:throw u(e)}}(this.id3Header.version.major);if(a+n>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}let o=e.subarray(a,a+n);a+=n;let d=function(e,a,i){switch(a){case 2:return function(e,a,r){let s={id:(0,m.textDecode)(e.subarray(0,3),"ascii"),length:t.UINT24_BE.get(e,3)};return s.id.match(/^[A-Z0-9]{3}$/)||r.addWarning(`Invalid ID3v2.${a} frame-header-ID: ${s.id}`),s}(e,a,i);case 3:case 4:return function(e,a,i){var n;let o={id:(0,m.textDecode)(e.subarray(0,4),"ascii"),length:(4===a?s.UINT32SYNCSAFE:t.UINT32_BE).get(e,4),flags:(n=e.subarray(8,10),{status:{tag_alter_preservation:r.getBit(n,0,6),file_alter_preservation:r.getBit(n,0,5),read_only:r.getBit(n,0,4)},format:{grouping_identity:r.getBit(n,1,7),compression:r.getBit(n,1,3),encryption:r.getBit(n,1,2),unsynchronisation:r.getBit(n,1,1),data_length_indicator:r.getBit(n,1,0)}})};return o.id.match(/^[A-Z0-9]{4}$/)||i.addWarning(`Invalid ID3v2.${a} frame-header-ID: ${o.id}`),o}(e,a,i);default:throw u(a)}}(o,this.id3Header.version.major,this.metadata),l=e.subarray(a,a+d.length);a+=d.length;let g=p.readFrameData(l,d,this.id3Header.version.major,!this.options.skipCovers,this.metadata);g&&i.push({id:d.id,value:g})}return i}}e.s(["ID3v2Parser",()=>p],38142)},22431,e=>{"use strict";e.i(50868);var t=e.i(22001),a=e.i(93432),r=e.i(1495),s=e.i(38142),i=e.i(30222),n=e.i(20881);let o=(0,a.default)("music-metadata:parser:ID3");class d extends n.BasicParser{constructor(){super(...arguments),this.id3parser=new s.ID3v2Parser}static async startsWithID3v2Header(e){return"ID3"===(await e.peekToken(r.ID3v2Header)).fileIdentifier}async parse(){try{await this.parseID3v2()}catch(e){if(e instanceof t.EndOfStreamError)o("End-of-stream");else throw e}}finalize(){}async parseID3v2(){if(await this.tryReadId3v2Headers(),o("End of ID3v2 header, go to MPEG-parser: pos=%s",this.tokenizer.position),await this.postId3v2Parse(),this.options.skipPostHeaders&&this.metadata.hasAny())this.finalize();else{let e=new i.ID3v1Parser(this.metadata,this.tokenizer,this.options);await e.parse(),this.finalize()}}async tryReadId3v2Headers(){if("ID3"===(await this.tokenizer.peekToken(r.ID3v2Header)).fileIdentifier)return o("Found ID3v2 header, pos=%s",this.tokenizer.position),await this.id3parser.parse(this.metadata,this.tokenizer,this.options),this.tryReadId3v2Headers()}}e.s(["AbstractID3Parser",()=>d])},84694,e=>{"use strict";var t=e.i(81995),a=e.i(62950);class r{constructor(e,t){this.data=e,this.offset=t}readInt32(){let e=t.UINT32_LE.get(this.data,this.offset);return this.offset+=4,e}readStringUtf8(){let e=this.readInt32(),t=(0,a.textDecode)(this.data.subarray(this.offset,this.offset+e),"utf-8");return this.offset+=e,t}parseUserComment(){let e=this.offset,t=this.readStringUtf8(),a=t.indexOf("=");return{key:t.substring(0,a).toUpperCase(),value:t.substring(a+1),len:this.offset-e}}}e.s(["VorbisDecoder",()=>r])},6754,e=>{"use strict";var t=e.i(81995),a=e.i(1495);class r{static fromBase64(e){return r.fromBuffer(Uint8Array.from(atob(e),e=>e.charCodeAt(0)))}static fromBuffer(e){return new r(e.length).get(e,0)}constructor(e){this.len=e}get(e,r){let s=a.AttachedPictureType[t.UINT32_BE.get(e,r)];r+=4;let i=t.UINT32_BE.get(e,r);r+=4;let n=new t.StringType(i,"utf-8").get(e,r);r+=i;let o=t.UINT32_BE.get(e,r);r+=4;let d=new t.StringType(o,"utf-8").get(e,r);r+=o;let l=t.UINT32_BE.get(e,r);r+=4;let g=t.UINT32_BE.get(e,r);r+=4;let c=t.UINT32_BE.get(e,r);r+=4;let h=t.UINT32_BE.get(e,r);r+=4;let m=t.UINT32_BE.get(e,r);return r+=4,{type:s,format:n,description:d,width:l,height:g,colour_depth:c,indexed_color:h,data:e.slice(r,r+m)}}}e.s(["CommonHeader",0,{len:7,get:(e,a)=>({packetType:t.UINT8.get(e,a),vorbis:new t.StringType(6,"ascii").get(e,a+1)})},"IdentificationHeader",0,{len:23,get:(e,a)=>({version:t.UINT32_LE.get(e,a+0),channelMode:t.UINT8.get(e,a+4),sampleRate:t.UINT32_LE.get(e,a+5),bitrateMax:t.UINT32_LE.get(e,a+9),bitrateNominal:t.UINT32_LE.get(e,a+13),bitrateMin:t.UINT32_LE.get(e,a+17)})},"VorbisPictureToken",()=>r])},43186,16495,61765,e=>{"use strict";var t=e.i(93432),a=e.i(81995),r=e.i(6754),s=e.i(22431),i=e.i(93403),n=e.i(84694),o=e.i(19102);let d=(0,t.default)("music-metadata:parser:ogg:vorbis1");class l extends(0,o.makeUnexpectedFileContentError)("Vorbis"){}class g{constructor(e,t){this.pageSegments=[],this.durationOnLastPage=!0,this.metadata=e,this.options=t}async parsePage(e,t){if(this.lastPageHeader=e,e.headerType.firstPage)this.parseFirstPage(e,t);else{if(e.headerType.continued){if(0===this.pageSegments.length)throw new l("Cannot continue on previous page");this.pageSegments.push(t)}if(e.headerType.lastPage||!e.headerType.continued){if(this.pageSegments.length>0){let e=g.mergeUint8Arrays(this.pageSegments);await this.parseFullPage(e)}this.pageSegments=e.headerType.lastPage?[]:[t]}}}static mergeUint8Arrays(e){let t=new Uint8Array(e.reduce((e,t)=>e+t.length,0));return e.forEach((e,a,r)=>{let s=r.slice(0,a).reduce((e,t)=>e+t.length,0);t.set(e,s)}),t}async flush(){await this.parseFullPage(g.mergeUint8Arrays(this.pageSegments))}async parseUserComment(e,t){let a=new n.VorbisDecoder(e,t).parseUserComment();return await this.addTag(a.key,a.value),a.len}async addTag(e,t){if("METADATA_BLOCK_PICTURE"===e&&"string"==typeof t){if(this.options.skipCovers)return void d("Ignore picture");t=r.VorbisPictureToken.fromBase64(t),d(`Push picture: id=${e}, format=${t.format}`)}else d(`Push tag: id=${e}, value=${t}`);await this.metadata.addTag("vorbis",e,t)}calculateDuration(e){this.lastPageHeader&&this.metadata.format.sampleRate&&this.lastPageHeader.absoluteGranulePosition>=0&&(this.metadata.setFormat("numberOfSamples",this.lastPageHeader.absoluteGranulePosition),this.metadata.setFormat("duration",this.lastPageHeader.absoluteGranulePosition/this.metadata.format.sampleRate))}parseFirstPage(e,t){this.metadata.setFormat("codec","Vorbis I"),this.metadata.setFormat("hasAudio",!0),d("Parse first page");let a=r.CommonHeader.get(t,0);if("vorbis"!==a.vorbis)throw new l("Metadata does not look like Vorbis");if(1===a.packetType){let e=r.IdentificationHeader.get(t,r.CommonHeader.len);this.metadata.setFormat("sampleRate",e.sampleRate),this.metadata.setFormat("bitrate",e.bitrateNominal),this.metadata.setFormat("numberOfChannels",e.channelMode),d("sample-rate=%s[hz], bitrate=%s[b/s], channel-mode=%s",e.sampleRate,e.bitrateNominal,e.channelMode)}else throw new l("First Ogg page should be type 1: the identification header")}async parseFullPage(e){let t=r.CommonHeader.get(e,0);if(d("Parse full page: type=%s, byteLength=%s",t.packetType,e.byteLength),3===t.packetType)return this.parseUserCommentList(e,r.CommonHeader.len)}async parseUserCommentList(e,t){let r=a.UINT32_LE.get(e,t);t+=4,t+=r;let s=a.UINT32_LE.get(e,t);for(t+=4;s-- >0;)t+=await this.parseUserComment(e,t)}}e.s(["VorbisStream",()=>g],16495);var c=o,h=e.i(6568);let m={STREAMINFO:0,PADDING:1,APPLICATION:2,SEEKTABLE:3,VORBIS_COMMENT:4,CUESHEET:5,PICTURE:6},u={len:4,get:(e,t)=>({lastBlock:h.getBit(e,t,7),type:h.getBitAllignedNumber(e,t,1,7),length:a.UINT24_BE.get(e,t+1)})},p={len:34,get:(e,t)=>({minimumBlockSize:a.UINT16_BE.get(e,t),maximumBlockSize:a.UINT16_BE.get(e,t+2)/1e3,minimumFrameSize:a.UINT24_BE.get(e,t+4),maximumFrameSize:a.UINT24_BE.get(e,t+7),sampleRate:a.UINT24_BE.get(e,t+10)>>4,channels:h.getBitAllignedNumber(e,t+12,4,3)+1,bitsPerSample:h.getBitAllignedNumber(e,t+12,7,5)+1,totalSamples:h.getBitAllignedNumber(e,t+13,4,36),fileMD5:new a.Uint8ArrayType(16).get(e,t+18)})};e.s(["BlockHeader",0,u,"BlockStreamInfo",0,p,"BlockType",0,m],61765);let T=(0,t.default)("music-metadata:parser:FLAC");class f extends(0,c.makeUnexpectedFileContentError)("FLAC"){}class y extends s.AbstractID3Parser{constructor(){super(...arguments),this.vorbisParser=new g(this.metadata,this.options),this.padding=0}async postId3v2Parse(){let e;if("fLaC"!==(await this.tokenizer.readToken(i.FourCcToken)).toString())throw new f("Invalid FLAC preamble");do e=await this.tokenizer.readToken(u),await this.parseDataBlock(e);while(!e.lastBlock)if(this.tokenizer.fileInfo.size&&this.metadata.format.duration){let e=this.tokenizer.fileInfo.size-this.tokenizer.position;this.metadata.setFormat("bitrate",8*e/this.metadata.format.duration)}}async parseDataBlock(e){switch(T(`blockHeader type=${e.type}, length=${e.length}`),e.type){case m.STREAMINFO:return this.readBlockStreamInfo(e.length);case m.PADDING:this.padding+=e.length;break;case m.APPLICATION:case m.SEEKTABLE:break;case m.VORBIS_COMMENT:return this.readComment(e.length);case m.CUESHEET:break;case m.PICTURE:await this.parsePicture(e.length);return;default:this.metadata.addWarning(`Unknown block type: ${e.type}`)}return this.tokenizer.ignore(e.length).then()}async readBlockStreamInfo(e){if(e!==p.len)throw new f("Unexpected block-stream-info length");let t=await this.tokenizer.readToken(p);this.metadata.setFormat("container","FLAC"),this.processsStreamInfo(t)}processsStreamInfo(e){this.metadata.setFormat("codec","FLAC"),this.metadata.setFormat("hasAudio",!0),this.metadata.setFormat("lossless",!0),this.metadata.setFormat("numberOfChannels",e.channels),this.metadata.setFormat("bitsPerSample",e.bitsPerSample),this.metadata.setFormat("sampleRate",e.sampleRate),e.totalSamples>0&&this.metadata.setFormat("duration",e.totalSamples/e.sampleRate)}async readComment(e){let t=await this.tokenizer.readToken(new a.Uint8ArrayType(e));return this.parseComment(t)}async parseComment(e){let t=new n.VorbisDecoder(e,0),a=t.readStringUtf8();a.length>0&&this.metadata.setFormat("tool",a);let r=t.readInt32(),s=Array(r);for(let e=0;e<r;e++)s[e]=t.parseUserComment();await Promise.all(s.map(e=>("ENCODER"===e.key&&this.metadata.setFormat("tool",e.value),this.addTag(e.key,e.value))))}async parsePicture(e){return this.options.skipCovers?this.tokenizer.ignore(e):this.addPictureTag(await this.tokenizer.readToken(new r.VorbisPictureToken(e)))}addPictureTag(e){return this.addTag("METADATA_BLOCK_PICTURE",e)}addTag(e,t){return this.vorbisParser.addTag(e,t)}}e.s(["FlacParser",()=>y],43186)},13529,e=>{"use strict";var t=e.i(81995);e.i(50868);var a=e.i(22001),r=e.i(93432),s=e.i(20881),i=e.i(16495),n=i,o=e.i(19102);class d extends(0,o.makeUnexpectedFileContentError)("Opus"){}class l{constructor(e){if(e<19)throw new d("ID-header-page 0 should be at least 19 bytes long");this.len=e}get(e,a){return{magicSignature:new t.StringType(8,"ascii").get(e,a+0),version:t.UINT8.get(e,a+8),channelCount:t.UINT8.get(e,a+9),preSkip:t.UINT16_LE.get(e,a+10),inputSampleRate:t.UINT32_LE.get(e,a+12),outputGain:t.UINT16_LE.get(e,a+16),channelMapping:t.UINT8.get(e,a+18)}}}class g extends n.VorbisStream{constructor(e,t,a){super(e,t),this.idHeader=null,this.lastPos=-1,this.tokenizer=a,this.durationOnLastPage=!0}parseFirstPage(e,t){if(this.metadata.setFormat("codec","Opus"),this.idHeader=new l(t.length).get(t,0),"OpusHead"!==this.idHeader.magicSignature)throw new d("Illegal ogg/Opus magic-signature");this.metadata.setFormat("sampleRate",this.idHeader.inputSampleRate),this.metadata.setFormat("numberOfChannels",this.idHeader.channelCount),this.metadata.setAudioOnly()}async parseFullPage(e){"OpusTags"===new t.StringType(8,"ascii").get(e,0)&&(await this.parseUserCommentList(e,8),this.lastPos=this.tokenizer.position-e.length)}calculateDuration(e){if(this.lastPageHeader&&(e||this.lastPageHeader.headerType.lastPage)&&this.metadata.format.sampleRate&&this.lastPageHeader.absoluteGranulePosition>=0){let e=this.lastPageHeader.absoluteGranulePosition-this.idHeader.preSkip;if(this.metadata.setFormat("numberOfSamples",e),this.metadata.setFormat("duration",e/48e3),-1!==this.lastPos&&this.tokenizer.fileInfo.size&&this.metadata.format.duration){let e=this.tokenizer.fileInfo.size-this.lastPos;this.metadata.setFormat("bitrate",8*e/this.metadata.format.duration)}}}}var c=i,h=e.i(6568);let m=(0,r.default)("music-metadata:parser:ogg:speex");class u extends c.VorbisStream{constructor(e,t,a){super(e,t)}parseFirstPage(e,a){let r,s;m("First Ogg/Speex page");let i=(r=a,s=0,{speex:new t.StringType(8,"ascii").get(r,s+0),version:h.trimRightNull(new t.StringType(20,"ascii").get(r,s+8)),version_id:t.INT32_LE.get(r,s+28),header_size:t.INT32_LE.get(r,s+32),rate:t.INT32_LE.get(r,s+36),mode:t.INT32_LE.get(r,s+40),mode_bitstream_version:t.INT32_LE.get(r,s+44),nb_channels:t.INT32_LE.get(r,s+48),bitrate:t.INT32_LE.get(r,s+52),frame_size:t.INT32_LE.get(r,s+56),vbr:t.INT32_LE.get(r,s+60),frames_per_packet:t.INT32_LE.get(r,s+64),extra_headers:t.INT32_LE.get(r,s+68),reserved1:t.INT32_LE.get(r,s+72),reserved2:t.INT32_LE.get(r,s+76)});this.metadata.setFormat("codec",`Speex ${i.version}`),this.metadata.setFormat("numberOfChannels",i.nb_channels),this.metadata.setFormat("sampleRate",i.rate),-1!==i.bitrate&&this.metadata.setFormat("bitrate",i.bitrate),this.metadata.setAudioOnly()}}let p=(0,r.default)("music-metadata:parser:ogg:theora");class T{constructor(e,t,a){this.durationOnLastPage=!1,this.metadata=e}async parsePage(e,t){e.headerType.firstPage&&await this.parseFirstPage(e,t)}calculateDuration(){p("duration calculation not implemented")}async parseFirstPage(e,a){let r,s;p("First Ogg/Theora page"),this.metadata.setFormat("codec","Theora");let i=(r=a,s=0,{id:new t.StringType(7,"ascii").get(r,s),vmaj:t.UINT8.get(r,s+7),vmin:t.UINT8.get(r,s+8),vrev:t.UINT8.get(r,s+9),vmbw:t.UINT16_BE.get(r,s+10),vmbh:t.UINT16_BE.get(r,s+17),nombr:t.UINT24_BE.get(r,s+37),nqual:t.UINT8.get(r,s+40)});this.metadata.setFormat("bitrate",i.nombr),this.metadata.setFormat("hasVideo",!0)}flush(){return Promise.resolve()}}var f=o;let y={len:27,get:(e,a)=>({capturePattern:new t.StringType(4,"latin1").get(e,a),version:t.UINT8.get(e,a+4),headerType:{continued:h.getBit(e,a+5,0),firstPage:h.getBit(e,a+5,1),lastPage:h.getBit(e,a+5,2)},absoluteGranulePosition:Number(t.UINT64_LE.get(e,a+6)),streamSerialNumber:t.UINT32_LE.get(e,a+14),pageSequenceNo:t.UINT32_LE.get(e,a+18),pageChecksum:t.UINT32_LE.get(e,a+22),page_segments:t.UINT8.get(e,a+26)})};class b{static sum(e,t,a){let r=new DataView(e.buffer,0),s=0;for(let e=t;e<t+a;++e)s+=r.getUint8(e);return s}constructor(e){this.len=e.page_segments}get(e,t){return{totalPageSize:b.sum(e,t,this.len)}}}var I=e.i(61765),P=e.i(43186),k=e.i(93403),w=e.i(6754);let S=(0,r.default)("music-metadata:parser:ogg:theora");class N{constructor(e,t,a){this.durationOnLastPage=!1,this.metadata=e,this.options=t,this.tokenizer=a,this.flacParser=new P.FlacParser(this.metadata,this.tokenizer,t)}async parsePage(e,t){e.headerType.firstPage&&await this.parseFirstPage(e,t)}calculateDuration(){S("duration calculation not implemented")}async parseFirstPage(e,t){if(S("First Ogg/FLAC page"),"fLaC"!==(await k.FourCcToken.get(t,9)).toString())throw Error("Invalid FLAC preamble");let a=await I.BlockHeader.get(t,13);await this.parseDataBlock(a,t.subarray(13+I.BlockHeader.len))}async parseDataBlock(e,t){switch(S(`blockHeader type=${e.type}, length=${e.length}`),e.type){case I.BlockType.STREAMINFO:{let e=I.BlockStreamInfo.get(t,0);return this.flacParser.processsStreamInfo(e)}case I.BlockType.PADDING:case I.BlockType.APPLICATION:case I.BlockType.SEEKTABLE:break;case I.BlockType.VORBIS_COMMENT:return this.flacParser.parseComment(t);case I.BlockType.PICTURE:if(!this.options.skipCovers){let e=new w.VorbisPictureToken(t.length).get(t,0);return this.flacParser.addPictureTag(e)}break;default:this.metadata.addWarning(`Unknown block type: ${e.type}`)}return this.tokenizer.ignore(e.length).then()}flush(){return Promise.resolve()}}class v extends(0,f.makeUnexpectedFileContentError)("Ogg"){}let E=(0,r.default)("music-metadata:parser:ogg");class C{constructor(e,t,a){this.pageNumber=0,this.closed=!1,this.metadata=e,this.streamSerial=t,this.options=a}async parsePage(e,a){this.pageNumber=a.pageSequenceNo,E("serial=%s page#=%s, Ogg.id=%s",a.streamSerialNumber,a.pageSequenceNo,a.capturePattern);let r=await e.readToken(new b(a));E("totalPageSize=%s",r.totalPageSize);let s=await e.readToken(new t.Uint8ArrayType(r.totalPageSize));if(E("firstPage=%s, lastPage=%s, continued=%s",a.headerType.firstPage,a.headerType.lastPage,a.headerType.continued),a.headerType.firstPage){this.metadata.setFormat("container","Ogg");let t=Array.from(s.subarray(0,7)).filter(e=>e>=32&&e<=126).map(e=>String.fromCharCode(e)).join("");switch(t){case"vorbis":E(`Set Ogg stream serial ${a.streamSerialNumber}, codec=Vorbis`),this.pageConsumer=new i.VorbisStream(this.metadata,this.options);break;case"OpusHea":E("Set page consumer to Ogg/Opus"),this.pageConsumer=new g(this.metadata,this.options,e);break;case"Speex  ":E("Set page consumer to Ogg/Speex"),this.pageConsumer=new u(this.metadata,this.options,e);break;case"fishead":case"theora":E("Set page consumer to Ogg/Theora"),this.pageConsumer=new T(this.metadata,this.options,e);break;case"FLAC":E("Set page consumer to Vorbis"),this.pageConsumer=new N(this.metadata,this.options,e);break;default:throw new v(`Ogg codec not recognized (id=${t}`)}}if(a.headerType.lastPage&&(this.closed=!0),this.pageConsumer)await this.pageConsumer.parsePage(a,s);else throw Error("pageConsumer should be initialized")}}class U extends s.BasicParser{constructor(){super(...arguments),this.streams=new Map}async parse(){let e;this.streams=new Map;let t=!1;try{do{if(e=await this.tokenizer.readToken(y),"OggS"!==e.capturePattern)throw new v("Invalid Ogg capture pattern");let t=this.streams.get(e.streamSerialNumber);if(t||(t=new C(this.metadata,e.streamSerialNumber,this.options),this.streams.set(e.streamSerialNumber,t)),await t.parsePage(this.tokenizer,e),t.pageNumber>12&&!(this.options.duration&&[...this.streams.values()].find(e=>e.pageConsumer?.durationOnLastPage))){E("Stop processing Ogg stream");break}}while(![...this.streams.values()].every(e=>e.closed))}catch(e){if(e instanceof a.EndOfStreamError)E("Reached end-of-stream"),t=!0;else if(e instanceof v)this.metadata.addWarning(`Corrupt Ogg content at ${this.tokenizer.position}`);else throw e}for(let e of this.streams.values())e.closed||(this.metadata.addWarning(`End-of-stream reached before reaching last page in Ogg stream serial=${e.streamSerial}`),await e.pageConsumer?.flush()),e.pageConsumer?.calculateDuration(t)}}e.s(["OggContentError",()=>v,"OggParser",()=>U],13529)}]);
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,38142,e=>{"use strict";var t=e.i(81995),a=e.i(93432),i=e.i(6568),r=e.i(1495),s=e.i(30222),n=e.i(19102);let l=(0,a.default)("music-metadata:id3v2:frame-parser"),o="latin1",d={encoding:o,bom:!1};function h(e){return"RX"===e?"Remix":"CR"===e?"Cover":e.match(/^\d*$/)?s.Genres[Number.parseInt(e,10)]:void 0}class c{constructor(e,t){this.major=e,this.warningCollector=t}readData(e,a,s){let n;if(0===e.length)return void this.warningCollector.addWarning(`id3v2.${this.major} header has empty tag type=${a}`);let{encoding:u,bom:f}=r.TextEncodingToken.get(e,0),g=e.length,p=0,b=[],y=c.getNullTerminatorLength(u);switch(l(`Parsing tag type=${a}, encoding=${u}, bom=${f}`),"TXXX"!==a&&"T"===a[0]?"T*":a){case"T*":case"GRP1":case"IPLS":case"MVIN":case"MVNM":case"PCS":case"PCST":{let t;try{t=c.trimNullPadding(i.decodeString(e.subarray(1),u))}catch(e){if(e instanceof Error){this.warningCollector.addWarning(`id3v2.${this.major} type=${a} header has invalid string value: ${e.message}`);break}throw e}switch(a){case"TMCL":case"TIPL":case"IPLS":b=c.functionList(this.splitValue(a,t));break;case"TRK":case"TRCK":case"TPOS":b=t;break;case"TCOM":case"TEXT":case"TOLY":case"TOPE":case"TPE1":case"TSRC":b=this.splitValue(a,t);break;case"TCO":case"TCON":b=this.splitValue(a,t).map(e=>(function(e){let t,a=[],i="";for(let r of e)if("string"==typeof t)if("("===r&&""===t)i+="(",t=void 0;else if(")"===r){""!==i&&(a.push(i),i="");let e=h(t);e&&a.push(e),t=void 0}else t+=r;else"("===r?t="":i+=r;return i&&(0===a.length&&i.match(/^\d*$/)&&(i=h(i)),i&&a.push(i)),a})(e)).reduce((e,t)=>e.concat(t),[]);break;case"PCS":case"PCST":b=Array.isArray(b=this.major>=4?this.splitValue(a,t):[t])&&""===b[0]?1:0;break;default:b=this.major>=4?this.splitValue(a,t):[t]}break}case"TXXX":{let t=c.readIdentifierAndData(e.subarray(1),u);b={description:t.id,text:this.splitValue(a,i.decodeString(t.data,u).replace(/\x00+$/,""))};break}case"PIC":case"APIC":if(s){let t={};switch(e=e.subarray(1),this.major){case 2:t.format=i.decodeString(e.subarray(0,3),"latin1"),e=e.subarray(3);break;case 3:case 4:n=i.findZero(e,o),t.format=i.decodeString(e.subarray(0,n),o),e=e.subarray(n+1);break;default:throw function(e){throw new m(`Unexpected majorVer: ${e}`)}(this.major)}t.format=c.fixPictureMimeType(t.format),t.type=r.AttachedPictureType[e[0]],e=e.subarray(1),n=i.findZero(e,u),t.description=i.decodeString(e.subarray(0,n),u),t.data=e=e.subarray(n+y),b=t}break;case"CNT":case"PCNT":b=(0,i.decodeUintBE)(e);break;case"SYLT":{let a=r.SyncTextHeader.get(e,0);e=e.subarray(r.SyncTextHeader.len);let i={descriptor:"",language:a.language,contentType:a.contentType,timeStampFormat:a.timeStampFormat,syncText:[]},s=!1;for(;e.length>0;){let r=c.readNullTerminatedString(e,a.encoding);if(e=e.subarray(r.len),s){let a=t.UINT32_BE.get(e,0);e=e.subarray(t.UINT32_BE.len),i.syncText.push({text:r.text,timestamp:a})}else i.descriptor=r.text,s=!0}b=i;break}case"ULT":case"USLT":case"COM":case"COMM":{let t=r.TextHeader.get(e,p);p+=r.TextHeader.len;let a=c.readNullTerminatedString(e.subarray(p),t.encoding);p+=a.len;let i=c.readNullTerminatedString(e.subarray(p),t.encoding);b={language:t.language,descriptor:a.text,text:i.text};break}case"UFID":{let t=c.readIdentifierAndData(e,o);b={owner_identifier:t.id,identifier:t.data};break}case"PRIV":{let t=c.readIdentifierAndData(e,o);b={owner_identifier:t.id,data:t.data};break}case"POPM":{e=e.subarray(p);let r=c.readNullTerminatedString(e,d),s=r.text;if(0===(e=e.subarray(r.len)).length){this.warningCollector.addWarning(`id3v2.${this.major} type=${a} POPM frame missing rating byte`),b={email:s,rating:0,counter:void 0};break}let n=t.UINT8.get(e,0),l=e.subarray(t.UINT8.len);b={email:s,rating:n,counter:l.length>0?(0,i.decodeUintBE)(l):void 0};break}case"GEOB":{let{encoding:t,bom:a}=r.TextEncodingToken.get(e,0);e=e.subarray(1);let i=c.readNullTerminatedString(e,d),s=i.text;e=e.subarray(i.len);let n=c.readNullTerminatedString(e,{encoding:t,bom:a}),l=n.text;e=e.subarray(n.len);let o=c.readNullTerminatedString(e,{encoding:t,bom:a});b={type:s,filename:l,description:o.text,data:e=e.subarray(o.len)};break}case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":b=c.readNullTerminatedString(e,d).text;break;case"WXXX":{let{encoding:t,bom:a}=r.TextEncodingToken.get(e,0);e=e.subarray(1);let s=c.readNullTerminatedString(e,{encoding:t,bom:a}),n=s.text;e=e.subarray(s.len),b={description:n,url:c.trimNullPadding(i.decodeString(e,o))};break}case"WFD":case"WFED":{let{encoding:t,bom:a}=r.TextEncodingToken.get(e,0);e=e.subarray(1),b=c.readNullTerminatedString(e,{encoding:t,bom:a}).text;break}case"MCDI":b=e.subarray(0,g);break;default:l(`Warning: unsupported id3v2-tag-type: ${a}`)}return b}static readNullTerminatedString(e,t){let a=2*!!t.bom,r=e.length,s=e.subarray(a),n=i.findZero(s,t.encoding);if(n>=s.length)return{text:i.decodeString(s,t.encoding),len:r};let l=s.subarray(0,n);return{text:i.decodeString(l,t.encoding),len:a+n+c.getNullTerminatorLength(t.encoding)}}static fixPictureMimeType(e){switch(e=e.toLocaleLowerCase()){case"jpg":return"image/jpeg";case"png":return"image/png"}return e}static functionList(e){let t={};for(let a=0;a+1<e.length;a+=2){let i=e[a+1].split(",");t[e[a]]=t[e[a]]?t[e[a]].concat(i):i}return t}splitValue(e,t){let a;return this.major<4?(a=t.split(/\x00/g)).length>1?this.warningCollector.addWarning(`ID3v2.${this.major} ${e} uses non standard null-separator.`):a=t.split(/\//g):a=t.split(/\x00/g),c.trimArray(a)}static trimArray(e){return e.map(e=>c.trimNullPadding(e).trim())}static trimNullPadding(e){let t=e.length;for(;t>0&&0===e.charCodeAt(t-1);)t--;return t===e.length?e:e.slice(0,t)}static readIdentifierAndData(e,t){let a=c.readNullTerminatedString(e,{encoding:t,bom:!1});return{id:a.text,data:e.subarray(a.len)}}static getNullTerminatorLength(e){return e.startsWith("utf-16")?2:1}}class m extends(0,n.makeUnexpectedFileContentError)("id3v2"){}var u=e.i(62950);function f(e){throw new m(`Unexpected majorVer: ${e}`)}class g{constructor(){this.tokenizer=void 0,this.id3Header=void 0,this.metadata=void 0,this.headerType=void 0,this.options=void 0}static removeUnsyncBytes(e){let t=0,a=0;for(;t<e.length-1;)t!==a&&(e[a]=e[t]),t+=255===e[t]&&0===e[t+1]?2:1,a++;return t<e.length&&(e[a++]=e[t]),e.subarray(0,a)}static readFrameData(e,t,a,i,r){let s=new c(a,r);switch(a){case 2:return s.readData(e,t.id,i);case 3:case 4:return t.flags?.format.unsynchronisation&&(e=g.removeUnsyncBytes(e)),t.flags?.format.data_length_indicator&&(e=e.subarray(4,e.length)),s.readData(e,t.id,i);default:throw function(e){throw new m(`Unexpected majorVer: ${e}`)}(a)}}static makeDescriptionTagName(e,t){return e+(t?`:${t}`:"")}async parse(e,t,a){this.tokenizer=t,this.metadata=e,this.options=a;let i=await this.tokenizer.readToken(r.ID3v2Header);if("ID3"!==i.fileIdentifier)throw new m("expected ID3-header file-identifier 'ID3' was not found");return this.id3Header=i,this.headerType=`ID3v2.${i.version.major}`,i.flags.isExtendedHeader?this.parseExtendedHeader():this.parseId3Data(i.size)}async parseExtendedHeader(){let e=await this.tokenizer.readToken(r.ExtendedHeader),t=e.size-r.ExtendedHeader.len;return t>0?this.parseExtendedHeaderData(t,e.size):this.parseId3Data(this.id3Header.size-e.size)}async parseExtendedHeaderData(e,t){return await this.tokenizer.ignore(e),this.parseId3Data(this.id3Header.size-t)}async parseId3Data(e){let a=await this.tokenizer.readToken(new t.Uint8ArrayType(e));for(let e of this.parseMetadata(a))"TXXX"===e.id?e.value&&await this.handleTag(e,e.value.text,()=>e.value.description):await (Array.isArray(e.value)?Promise.all(e.value.map(t=>this.addTag(e.id,t))):this.addTag(e.id,e.value))}async handleTag(e,t,a,i=e=>e){await Promise.all(t.map(t=>this.addTag(g.makeDescriptionTagName(e.id,a(t)),i(t))))}async addTag(e,t){await this.metadata.addTag(this.headerType,e,t)}parseMetadata(e){let a=0,s=[];for(;a!==e.length;){let n=function(e){switch(e){case 2:return 6;case 3:case 4:return 10;default:throw f(e)}}(this.id3Header.version.major);if(a+n>e.length){this.metadata.addWarning("Illegal ID3v2 tag length");break}let l=e.subarray(a,a+n);a+=n;let o=function(e,a,s){switch(a){case 2:return function(e,a,i){let r={id:(0,u.textDecode)(e.subarray(0,3),"ascii"),length:t.UINT24_BE.get(e,3)};return r.id.match(/^[A-Z0-9]{3}$/)||i.addWarning(`Invalid ID3v2.${a} frame-header-ID: ${r.id}`),r}(e,a,s);case 3:case 4:return function(e,a,s){var n;let l={id:(0,u.textDecode)(e.subarray(0,4),"ascii"),length:(4===a?r.UINT32SYNCSAFE:t.UINT32_BE).get(e,4),flags:(n=e.subarray(8,10),{status:{tag_alter_preservation:i.getBit(n,0,6),file_alter_preservation:i.getBit(n,0,5),read_only:i.getBit(n,0,4)},format:{grouping_identity:i.getBit(n,1,7),compression:i.getBit(n,1,3),encryption:i.getBit(n,1,2),unsynchronisation:i.getBit(n,1,1),data_length_indicator:i.getBit(n,1,0)}})};return l.id.match(/^[A-Z0-9]{4}$/)||s.addWarning(`Invalid ID3v2.${a} frame-header-ID: ${l.id}`),l}(e,a,s);default:throw f(a)}}(l,this.id3Header.version.major,this.metadata),d=e.subarray(a,a+o.length);a+=o.length;let h=g.readFrameData(d,o,this.id3Header.version.major,!this.options.skipCovers,this.metadata);h&&s.push({id:o.id,value:h})}return s}}e.s(["ID3v2Parser",()=>g],38142)},22431,e=>{"use strict";e.i(50868);var t=e.i(22001),a=e.i(93432),i=e.i(1495),r=e.i(38142),s=e.i(30222),n=e.i(20881);let l=(0,a.default)("music-metadata:parser:ID3");class o extends n.BasicParser{constructor(){super(...arguments),this.id3parser=new r.ID3v2Parser}static async startsWithID3v2Header(e){return"ID3"===(await e.peekToken(i.ID3v2Header)).fileIdentifier}async parse(){try{await this.parseID3v2()}catch(e){if(e instanceof t.EndOfStreamError)l("End-of-stream");else throw e}}finalize(){}async parseID3v2(){if(await this.tryReadId3v2Headers(),l("End of ID3v2 header, go to MPEG-parser: pos=%s",this.tokenizer.position),await this.postId3v2Parse(),this.options.skipPostHeaders&&this.metadata.hasAny())this.finalize();else{let e=new s.ID3v1Parser(this.metadata,this.tokenizer,this.options);await e.parse(),this.finalize()}}async tryReadId3v2Headers(){if("ID3"===(await this.tokenizer.peekToken(i.ID3v2Header)).fileIdentifier)return l("Found ID3v2 header, pos=%s",this.tokenizer.position),await this.id3parser.parse(this.metadata,this.tokenizer,this.options),this.tryReadId3v2Headers()}}e.s(["AbstractID3Parser",()=>o])},52911,e=>{"use strict";var t=e.i(81995);e.i(50868);var a=e.i(22001),i=e.i(93432),r=e.i(6568),s=e.i(22431);let n=(e,t)=>{let a=r.getBitAllignedNumber(e,t,0,3),i=r.getBitAllignedNumber(e,t,6,1),s=r.getBitAllignedNumber(e,t,7,9)/10;if(a>0)return{type:r.getBitAllignedNumber(e,t,0,3),origin:r.getBitAllignedNumber(e,t,3,3),adjustment:i?-s:s}},l={len:27,get:(e,a)=>{let i=t.UINT32_BE.get(e,a+2);return{revision:r.getBitAllignedNumber(e,a,0,4),vbr_method:r.getBitAllignedNumber(e,a,4,4),lowpass_filter:100*t.UINT8.get(e,a+1),track_peak:0===i?null:i/8388608,track_gain:n(e,6),album_gain:n(e,8),music_length:t.UINT32_BE.get(e,a+20),music_crc:t.UINT8.get(e,a+24),header_crc:t.UINT16_BE.get(e,a+24)}}},o=new t.StringType(4,"ascii"),d=new t.StringType(6,"ascii"),h={len:4,get:(e,t)=>({frames:r.isBitSet(e,t,31),bytes:r.isBitSet(e,t,30),toc:r.isBitSet(e,t,29),vbrScale:r.isBitSet(e,t,28)})};async function c(e){let a=await e.readToken(h),i={numFrames:null,streamSize:null,vbrScale:null};if(a.frames&&(i.numFrames=await e.readToken(t.UINT32_BE)),a.bytes&&(i.streamSize=await e.readToken(t.UINT32_BE)),a.toc&&(i.toc=new Uint8Array(100),await e.readBuffer(i.toc)),a.vbrScale&&(i.vbrScale=await e.readToken(t.UINT32_BE)),"LAME"===await e.peekToken(new t.StringType(4,"ascii"))){await e.ignore(4),i.lame={version:await e.readToken(new t.StringType(5,"ascii"))};let a=i.lame.version.match(/\d+.\d+/g);if(null!==a){let t=a[0].split(".").map(e=>Number.parseInt(e,10));t[0]>=3&&t[1]>=90&&(i.lame.extended=await e.readToken(l))}}return i}var m=e.i(19102);let u=(0,i.default)("music-metadata:parser:mpeg");class f extends(0,m.makeUnexpectedFileContentError)("MPEG"){}let g=["AAC Main","AAC LC","AAC SSR","AAC LTP"],p=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350,null,null,-1],b=[void 0,["front-center"],["front-left","front-right"],["front-center","front-left","front-right"],["front-center","front-left","front-right","back-center"],["front-center","front-left","front-right","back-left","back-right"],["front-center","front-left","front-right","back-left","back-right","LFE-channel"],["front-center","front-left","front-right","side-left","side-right","back-left","back-right","LFE-channel"]];class y{constructor(e,t){this.bitrateIndex=null,this.sampRateFreqIndex=null,this.padding=null,this.privateBit=null,this.channelModeIndex=null,this.modeExtension=null,this.isOriginalMedia=null,this.version=null,this.bitrate=null,this.samplingRate=null,this.frameLength=0,this.versionIndex=r.getBitAllignedNumber(e,t+1,3,2),this.layer=y.LayerDescription[r.getBitAllignedNumber(e,t+1,5,2)],this.versionIndex>1&&0===this.layer?this.parseAdtsHeader(e,t):this.parseMpegHeader(e,t),this.isProtectedByCRC=!r.isBitSet(e,t+1,7)}calcDuration(e){return null==this.samplingRate?null:e*this.calcSamplesPerFrame()/this.samplingRate}calcSamplesPerFrame(){return y.samplesInFrameTable[+(1!==this.version)][this.layer]}calculateSideInfoLength(){if(3!==this.layer)return 2;if(3===this.channelModeIndex){if(1===this.version)return 17;if(2===this.version||2.5===this.version)return 9}else{if(1===this.version)return 32;if(2===this.version||2.5===this.version)return 17}return null}calcSlotSize(){return[null,4,1,1][this.layer]}parseMpegHeader(e,t){this.container="MPEG",this.bitrateIndex=r.getBitAllignedNumber(e,t+2,0,4),this.sampRateFreqIndex=r.getBitAllignedNumber(e,t+2,4,2),this.padding=r.isBitSet(e,t+2,6),this.privateBit=r.isBitSet(e,t+2,7),this.channelModeIndex=r.getBitAllignedNumber(e,t+3,0,2),this.modeExtension=r.getBitAllignedNumber(e,t+3,2,2),this.isCopyrighted=r.isBitSet(e,t+3,4),this.isOriginalMedia=r.isBitSet(e,t+3,5),this.emphasis=r.getBitAllignedNumber(e,t+3,7,2),this.version=y.VersionID[this.versionIndex],this.channelMode=y.ChannelMode[this.channelModeIndex],this.codec=`MPEG ${this.version} Layer ${this.layer}`;let a=this.calcBitrate();if(!a)throw new f("Cannot determine bit-rate");if(this.bitrate=1e3*a,this.samplingRate=this.calcSamplingRate(),null==this.samplingRate)throw new f("Cannot determine sampling-rate")}parseAdtsHeader(e,t){u("layer=0 => ADTS"),this.version=2===this.versionIndex?4:2,this.container=`ADTS/MPEG-${this.version}`;let a=r.getBitAllignedNumber(e,t+2,0,2);this.codec="AAC",this.codecProfile=g[a],u(`MPEG-4 audio-codec=${this.codec}`);let i=r.getBitAllignedNumber(e,t+2,2,4);this.samplingRate=p[i],u(`sampling-rate=${this.samplingRate}`);let s=r.getBitAllignedNumber(e,t+2,7,3);this.mp4ChannelConfig=b[s],u(`channel-config=${this.mp4ChannelConfig?this.mp4ChannelConfig.join("+"):"?"}`),this.frameLength=r.getBitAllignedNumber(e,t+3,6,2)<<11}calcBitrate(){if(0===this.bitrateIndex||15===this.bitrateIndex)return null;if(this.version&&this.bitrateIndex){let e=10*Math.floor(this.version)+this.layer;return y.bitrate_index[this.bitrateIndex][e]}return null}calcSamplingRate(){return 3===this.sampRateFreqIndex||null===this.version||null==this.sampRateFreqIndex?null:y.sampling_rate_freq_index[this.version][this.sampRateFreqIndex]}}y.SyncByte1=255,y.SyncByte2=224,y.VersionID=[2.5,null,2,1],y.LayerDescription=[0,3,2,1],y.ChannelMode=["stereo","joint_stereo","dual_channel","mono"],y.bitrate_index={1:{11:32,12:32,13:32,21:32,22:8,23:8},2:{11:64,12:48,13:40,21:48,22:16,23:16},3:{11:96,12:56,13:48,21:56,22:24,23:24},4:{11:128,12:64,13:56,21:64,22:32,23:32},5:{11:160,12:80,13:64,21:80,22:40,23:40},6:{11:192,12:96,13:80,21:96,22:48,23:48},7:{11:224,12:112,13:96,21:112,22:56,23:56},8:{11:256,12:128,13:112,21:128,22:64,23:64},9:{11:288,12:160,13:128,21:144,22:80,23:80},10:{11:320,12:192,13:160,21:160,22:96,23:96},11:{11:352,12:224,13:192,21:176,22:112,23:112},12:{11:384,12:256,13:224,21:192,22:128,23:128},13:{11:416,12:320,13:256,21:224,22:144,23:144},14:{11:448,12:384,13:320,21:256,22:160,23:160}},y.sampling_rate_freq_index={1:{0:44100,1:48e3,2:32e3},2:{0:22050,1:24e3,2:16e3},2.5:{0:11025,1:12e3,2:8e3}},y.samplesInFrameTable=[[0,384,1152,1152],[0,384,1152,576]];class k extends s.AbstractID3Parser{constructor(){super(...arguments),this.frameCount=0,this.syncFrameCount=-1,this.countSkipFrameData=0,this.totalDataLength=0,this.bitrates=[],this.offset=0,this.frame_size=0,this.crc=null,this.calculateEofDuration=!1,this.samplesPerFrame=null,this.buf_frame_header=new Uint8Array(4),this.mpegOffset=null,this.syncPeek={buf:new Uint8Array(1024),len:0}}async postId3v2Parse(){this.metadata.setFormat("lossless",!1),this.metadata.setAudioOnly();try{let e=!1;for(;!e;)await this.sync(),e=await this.parseCommonMpegHeader()}catch(e){if(e instanceof a.EndOfStreamError){if(u("End-of-stream"),this.calculateEofDuration&&null!==this.samplesPerFrame){let e=this.frameCount*this.samplesPerFrame;if(this.metadata.setFormat("numberOfSamples",e),this.metadata.format.sampleRate){let t=e/this.metadata.format.sampleRate;u(`Calculate duration at EOF: ${t} sec.`,t),this.metadata.setFormat("duration",t)}}}else throw e}}finalize(){let e=this.metadata.format,t=!!this.metadata.native.ID3v1;if(null!==this.mpegOffset){if(e.duration&&this.tokenizer.fileInfo.size){let a=this.tokenizer.fileInfo.size-this.mpegOffset-128*!!t;e.codecProfile&&"V"===e.codecProfile[0]&&this.metadata.setFormat("bitrate",8*a/e.duration)}if(this.tokenizer.fileInfo.size&&"CBR"===e.codecProfile){let a=this.tokenizer.fileInfo.size-this.mpegOffset-128*!!t;if(null!==this.frame_size&&null!==this.samplesPerFrame){let t=Math.round(a/this.frame_size)*this.samplesPerFrame;if(this.metadata.setFormat("numberOfSamples",t),e.sampleRate&&!e.duration){let a=t/e.sampleRate;u("Calculate CBR duration based on file size: %s",a),this.metadata.setFormat("duration",a)}}}}}async sync(){let e=!1;for(;;){let t=0;if(this.syncPeek.len=await this.tokenizer.peekBuffer(this.syncPeek.buf,{length:1024,mayBeLess:!0}),this.syncPeek.len<=163)throw new a.EndOfStreamError;for(;;){if(e&&(224&this.syncPeek.buf[t])==224){this.buf_frame_header[0]=y.SyncByte1,this.buf_frame_header[1]=this.syncPeek.buf[t],await this.tokenizer.ignore(t),u(`Sync at offset=${this.tokenizer.position-1}, frameCount=${this.frameCount}`),this.syncFrameCount===this.frameCount&&(u(`Re-synced MPEG stream, frameCount=${this.frameCount}`),this.frameCount=0,this.frame_size=0),this.syncFrameCount=this.frameCount;return}if(e=!1,-1===(t=this.syncPeek.buf.indexOf(y.SyncByte1,t))){if(this.syncPeek.len<this.syncPeek.buf.length)throw new a.EndOfStreamError;await this.tokenizer.ignore(this.syncPeek.len);break}++t,e=!0}}}async parseCommonMpegHeader(){let e;0===this.frameCount&&(this.mpegOffset=this.tokenizer.position-1),await this.tokenizer.peekBuffer(this.buf_frame_header.subarray(1),{length:3});try{let t,a;t=this.buf_frame_header,a=0,e=new y(t,a)}catch(e){if(await this.tokenizer.ignore(1),e instanceof Error)return this.metadata.addWarning(`Parse error: ${e.message}`),!1;throw e}return await this.tokenizer.ignore(3),this.metadata.setFormat("container",e.container),this.metadata.setFormat("codec",e.codec),this.metadata.setFormat("lossless",!1),this.metadata.setFormat("sampleRate",e.samplingRate),this.frameCount++,null!==e.version&&e.version>=2&&0===e.layer?this.parseAdts(e):this.parseAudioFrameHeader(e)}async parseAudioFrameHeader(e){this.metadata.setFormat("numberOfChannels","mono"===e.channelMode?1:2),this.metadata.setFormat("bitrate",e.bitrate),this.frameCount<2e5&&u("offset=%s MP%s bitrate=%s sample-rate=%s",this.tokenizer.position-4,e.layer,e.bitrate,e.samplingRate);let t=e.calcSlotSize();if(null===t)throw new f("invalid slot_size");let a=e.calcSamplesPerFrame();if(u(`samples_per_frame=${a}`),null!==e.bitrate&&null!=e.samplingRate){let i=a/8*e.bitrate/e.samplingRate+(e.padding?t:0);this.frame_size=Math.floor(i)}if(this.audioFrameHeader=e,null!==e.bitrate&&this.bitrates.push(e.bitrate),1===this.frameCount)return this.offset=4,await this.skipSideInformation(),!1;if(4===this.frameCount){if(this.areAllSame(this.bitrates)){if(this.samplesPerFrame=a,this.metadata.setFormat("codecProfile","CBR"),this.tokenizer.fileInfo.size)return!0}else if(this.metadata.format.duration)return!0;if(!this.options.duration)return!0}return(this.options.duration&&4===this.frameCount&&(this.samplesPerFrame=a,this.calculateEofDuration=!0),this.offset=4,e.isProtectedByCRC)?await this.parseCrc():await this.skipSideInformation(),!1}async parseAdts(e){let t=new Uint8Array(3);if(await this.tokenizer.readBuffer(t),e.frameLength+=r.getBitAllignedNumber(t,0,0,11),this.totalDataLength+=e.frameLength,this.samplesPerFrame=1024,null!==e.samplingRate){let t=e.samplingRate/this.samplesPerFrame,a=8*(0===this.frameCount?0:this.totalDataLength/this.frameCount)*t+.5;this.metadata.setFormat("bitrate",a),u(`frame-count=${this.frameCount}, size=${e.frameLength} bytes, bit-rate=${a}`)}if(await this.tokenizer.ignore(e.frameLength>7?e.frameLength-7:1),3===this.frameCount){if(this.metadata.setFormat("codecProfile",e.codecProfile),e.mp4ChannelConfig&&this.metadata.setFormat("numberOfChannels",e.mp4ChannelConfig.length),!this.options.duration)return!0;this.calculateEofDuration=!0}return!1}async parseCrc(){return this.crc=await this.tokenizer.readNumber(t.INT16_BE),this.offset+=2,this.skipSideInformation()}async skipSideInformation(){if(this.audioFrameHeader){let e=this.audioFrameHeader.calculateSideInfoLength();if(null!==e){await this.tokenizer.readToken(new t.Uint8ArrayType(e)),this.offset+=e,await this.readXtraInfoHeader();return}}}async readXtraInfoHeader(){let e=await this.tokenizer.readToken(o);switch(this.offset+=o.len,e){case"Info":return this.metadata.setFormat("codecProfile","CBR"),this.readXingInfoHeader();case"Xing":{let e=await this.readXingInfoHeader();if(null!==e.vbrScale){var t;let a=(t=e.vbrScale,`V${Math.floor((100-t)/10)}`);this.metadata.setFormat("codecProfile",a)}return null}case"Xtra":break;case"LAME":{let e=await this.tokenizer.readToken(d);if(null!==this.frame_size&&this.frame_size>=this.offset+d.len)return this.offset+=d.len,this.metadata.setFormat("tool",`LAME ${e}`),await this.skipFrameData(this.frame_size-this.offset),null;this.metadata.addWarning("Corrupt LAME header")}}let a=this.frame_size-this.offset;return a<0?this.metadata.addWarning(`Frame ${this.frameCount}corrupt: negative frameDataLeft`):await this.skipFrameData(a),null}async readXingInfoHeader(){let e=this.tokenizer.position,t=await c(this.tokenizer);if(this.offset+=this.tokenizer.position-e,t.lame&&(this.metadata.setFormat("tool",`LAME ${r.stripNulls(t.lame.version)}`),t.lame.extended&&(this.metadata.setFormat("trackPeakLevel",t.lame.extended.track_peak),t.lame.extended.track_gain&&this.metadata.setFormat("trackGain",t.lame.extended.track_gain.adjustment),t.lame.extended.album_gain&&this.metadata.setFormat("albumGain",t.lame.extended.album_gain.adjustment),this.metadata.setFormat("duration",t.lame.extended.music_length/1e3))),t.streamSize&&this.audioFrameHeader&&null!==t.numFrames){let e=this.audioFrameHeader.calcDuration(t.numFrames);return this.metadata.setFormat("duration",e),u("Get duration from Xing header: %s",this.metadata.format.duration),t}let a=this.frame_size-this.offset;return await this.skipFrameData(a),t}async skipFrameData(e){if(e<0)throw new f("frame-data-left cannot be negative");await this.tokenizer.ignore(e),this.countSkipFrameData+=e}areAllSame(e){let t=e[0];return e.every(e=>e===t)}}e.s(["MpegContentError",()=>f,"MpegParser",()=>k],52911)}]);